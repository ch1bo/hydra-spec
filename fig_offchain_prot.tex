\begin{figure*}[t!]

  \def\sfact{0.8}
  \centering
  \begin{algobox}{Coordinated Hydra Head}
    \medskip
    \begin{tabular}{c}
      \begin{tabular}{cc}
        \adjustbox{valign=t,scale=\sfact}{
         \begin{walgo}{0.65}
          %%% INIT
          \On{$(\hpInit,i,\hpPuv,\hpPr,\Uinit)$ %
            from client}{ %
            % let $i$ be position of $\hpPr$'s public key in $\hpPuv$
            % \; %
            $\msVKL \gets \hpPuv$ \; %
            $\msCVK \gets \msCombVK(\msVKL)$ \; %
            $\msSK \gets \hpPr$ \; %c

            $\hats,\bars \gets 0$ \; %
            $\hatmU, \barmU \gets \Sno (0,\Uinit)$ \; %
            % $\hatmL,\barmL \gets \Uinit$ \; %
            $\hatmL \gets \Uinit$ \; %
            % $\hatmT,\barmT \gets \emptyset$ \; %
            $\mT, \hatmT,  \barmT \gets \emptyset$ \; % all, seenforsnap, confirmedforsnap
          }

          
          \vspace{12pt} %
          
          %%% NEW TX
          \On{$(\hpNew,\tx)$ from client}{%
            \Req{} $\validTx(\tx) \land \hatmL \applytx \tx \neq \bot$\;
            \Multi{} $(\hpRT,\tx)$%
          }

        \end{walgo}
        }
        &

        \adjustbox{valign=t,scale=\sfact}{
        \begin{walgo}{0.6}
          %%% CLOSE
          \On{$(\hpClose)$ from client}{ %
            \Return $(\barmU.U, \barmU.s, \barmU.\msCSig)$ \; %
          }
          
          \vspace{12pt} %
          
          %%% CONTEST
          \On{$(\hpCont,\eta)$ from client}{ %
            $(U_\eta,s_\eta) \gets \eta$ \; %

            % FIXME: this was completely wrong? check with researchers
            % \Req{} $s_\eta > \bars$ %
            % \Return $(U_\eta,s_\eta)$ \; %

            \Req{} $\bars > s_\eta $ \; %
            \Return $(\barmU.U, \barmU.s, \barmU.\msCSig)$ \; %

          }

          \vspace{12pt}

          % \On{$(\hpFinalize,\eta)$ from client}{ %
          %   $(\hash,s,T) \gets \eta$ \; %            
          % }    
          

        \end{walgo}
          }
        % &
        
        % \adjustbox{valign=t,scale=\sfact}{
        % \begin{walgo}{0.3}
        %   \If{bla}{
        %     bla \; %
        %   }      
        % \end{walgo}} %

      \end{tabular}
      
      \vspace{-10pt}
      \\
      % \ifdefined\IsLLNCS %
        \multicolumn{1}{l}{\line(1,0){490}} %
      % \else %
      %   \multicolumn{1}{l}{\line(1,0){465}} %
      % \fi %
      \\

      \begin{tabular}{c@{}c}
        \adjustbox{valign=t,scale=\sfact}{
        \begin{walgo}{0.65}
          %%% REQ TX
          \On{$(\hpRT,\tx)$ from $\party_j$}{%
            \Req{} $\validTx(\tx) \land \hatmL \applytx \tx \neq \bot$ \;
            
            $\mT[\hash] \gets \tx$ % all seen txs

            $\hatmT[\hash] \gets \mT[\hash]$ % candidates for next snapshot \; %

            $\hatmL \gets \hatmL\applytx\tx$ %

            % issue snapshot?
            \If{$\hats = \bars \land \hpLdr(\bars + 1) = i$}{%
              \Multi{} $(\hpRS,\bars+1,\hatmT\hpProjH)$ \;%
            }
            
          }

          \vspace{12pt} %

          %%% REQ SN
          \On{$(\hpRS,s,T)$ from $\party_j$}{ %

            \Req{} $s = \hats + 1 \land \hpLdr(s) = j$ \; %

            \Wait{$\bars = \hats \land \barmU\applytx T \not= \bot$ % meaning reach is 'complete' for extension
            }{ %
               $\hats \gets \bars + 1$ \; %

               % TODO: update security definition to observe without output keyword
               % $\forall\tx\in\Reach^{\mT}(T)$:
               %  \Out $(\hpSeen,\tx)$ \; %

               $\hatmU \gets
               \Sno(\hats,\barmU\applytx T )$ \; %

               $\msSig_i \gets %
               \msSign(\hyPr, (\hats \| U_{0}.h) \| \hatmU.h)$ \; %
 
               \Send $(\hpAS,\hats,\msSig_i)$ %
               to $\party_j$ \; %

               % \If{$\hpLdr(\hats+1) = i$}{
                 $\hatmT :\subseteq_{\mbox{max}} \mT$ s.t. $\hatmU\applytx\hatmT\not=\bot$ \; %
                 $\hatmL \gets \hatmU\applytx\hatmT$
               % }
            }
           }
          
        \end{walgo}
        }
        &

        \adjustbox{valign=t,scale=\sfact}{
        \begin{walgo}{0.6}
          %%% ACK SN
          \On{$(\hpAS,s,\msSig_j)$ %
            from $\party_j$}{ %

            \Req{} $s \in \{\hats,\hats+1\}$ \; % 2-round ack/confirmation
            % and $\hySignedU.\hySN = \hySN$ \; %

            \Wait{$\hats=s$
            }{ %
            
            \Req{} $\hatmU.\hpSigs[j] = \undefined$ \; %

            $\hatmU.\hpSigs[j] \gets \msSig_j$ \; %

            \If{$\forall k: \hatmU.\hpSigs[k] \neq \undefined$}{ %
              $\msCSig %
              \gets \msComb((s \| U_{0}.h) \| \hatmU.\hash, %
              \msVKL, \hatmU.\hpSigs)$ \; %
              
              \If{$\msVfy(\msCVK, (\hats \| U_{0}.h) \| \hatmU.\hash,\msCSig)$}{ %
              $\bars \gets s$ \; %
              $\hatmU.\msCSig \gets \msCSig$ \; %
              $\barmU \gets \hatmU$ \; %
              $\barmT \gets \barmT \cup \barmU.T$ \; %

              % TODO: update security definition to observe without output
              % keyword
              % $\forall \tx\in T$: \Out $(\hpConf,\tx)$ \; %

              % issue snapshot?
              \If{$\hats = \bars \land \hpLdr(\bars + 1) = i \land \hatmT \neq \emptyset$}{%
                \Multi{} $(\hpRS,\bars+1,\hatmT\hpProjH)$ \;%
              }

  
            }\Else{
             \fail
            }%
            }
           }
          }  
        \end{walgo}

          }
          
        % &
        
        % \adjustbox{valign=t,scale=\sfact}{
        % \begin{walgo}{0.3}
        %   \If{bla}{
        %     bla \; %
        %   }      
        % \end{walgo}} %

      \end{tabular}


    \end{tabular}
    \bigskip
  \end{algobox}
  
  \caption{Head-protocol machine for the \emph{coordinated head} from the perspective of party
    $\party_i$.}
  \label{fig:head_coordinated}

\end{figure*}



%%% Local Variables:
%%% mode: latex
%%% TeX-master: "main"
%%% End:
